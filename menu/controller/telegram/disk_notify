#!/bin/bash

######################################################################
#           Auto Install & Optimize LEMP Stack on CentOS            #
#                                                                    #
#                Author: HOSTVN Technical Team                       #
#                  Website: https://hostvn.vn                        #
#                                                                    #
#              Please do not remove copyright. Thank!                #
#  Please do not copy under any circumstance for commercial reason!  #
######################################################################

source /var/hostvn/menu/validate/rule
source /var/hostvn/menu/helpers/function

_create_disk_notify_file(){
    mkdir -p /var/hostvn/telegram
    cat >> "/var/hostvn/telegram/diskNotify.sh" << END
#!/bin/bash

CHAT_ID="$TELEGRAM_ID"
TOKEN="$TELEGRAM_TOKEN"
TIMEOUT="10"
URL="https://api.telegram.org/bot\$TOKEN/sendMessage"
DATE_EXEC="\$(date "+%d %b %Y %H:%M")"
IPADDR=\$(curl -s ipinfo.io/ip)

# Check disk usage
DISK_USAGE=\$(df -h / | awk 'NR==2 {print \$5}' | sed 's/%//')

if [ "\$DISK_USAGE" -ge 80 ]; then
    TEXT="\$DATE_EXEC: CANH BAO - Disk usage tren VPS \$IPADDR da dat \$DISK_USAGE%"
    curl -s --max-time \$TIMEOUT -d "chat_id=\$CHAT_ID&disable_web_page_preview=1&text=\$TEXT" \$URL > /dev/null
fi

# Check memory usage
MEMORY_USAGE=\$(free | grep Mem | awk '{printf("%.0f", \$3/\$2 * 100.0)}')

if [ "\$MEMORY_USAGE" -ge 90 ]; then
    TEXT="\$DATE_EXEC: CANH BAO - Memory usage tren VPS \$IPADDR da dat \$MEMORY_USAGE%"
    curl -s --max-time \$TIMEOUT -d "chat_id=\$CHAT_ID&disable_web_page_preview=1&text=\$TEXT" \$URL > /dev/null
fi

# Check load average
LOAD_AVG=\$(uptime | awk -F'load average:' '{print \$2}' | awk '{print \$1}' | sed 's/,//')
CPU_CORES=\$(nproc)
LOAD_THRESHOLD=\$(echo "\$CPU_CORES * 2" | bc -l)

if (( \$(echo "\$LOAD_AVG > \$LOAD_THRESHOLD" | bc -l) )); then
    TEXT="\$DATE_EXEC: CANH BAO - Load average tren VPS \$IPADDR: \$LOAD_AVG (Cores: \$CPU_CORES)"
    curl -s --max-time \$TIMEOUT -d "chat_id=\$CHAT_ID&disable_web_page_preview=1&text=\$TEXT" \$URL > /dev/null
fi
END

    chmod +x /var/hostvn/telegram/diskNotify.sh
}

_add_cronjob(){
    crontab -l > disk_notify_cron
    echo "*/10 * * * * /var/hostvn/telegram/diskNotify.sh >/dev/null 2>&1" >> disk_notify_cron
    crontab disk_notify_cron
    rm -rf disk_notify_cron
}

_run(){
    check_disk_notify=$(crontab -l | grep -c "diskNotify.sh")
    if [ "${check_disk_notify}" -ge 1 ]; then
        ALERT=$(printf "%s" "${RED}Ban da tao Disk Notify roi.${NC}")
    else
        read -r -p "Nhap vao Telegram Chat ID: " TELEGRAM_ID
        read -r -p "Nhap vao Telegram Token: " TELEGRAM_TOKEN

        if [ -z "$TELEGRAM_ID" ]; then
            ALERT=$(printf "%s" "${RED}Ban chua nhap Telegram ID.${NC}")
        elif [ -z "$TELEGRAM_TOKEN" ]; then
            ALERT=$(printf "%s" "${RED}Ban chua nhap Telegram Token.${NC}")
        else
            _create_disk_notify_file
            _add_cronjob
            ALERT=$(printf "%s" "${GREEN}Tao Disk Notify thanh cong.${NC}")
        fi
    fi
}

TELEGRAM_ID=""
TELEGRAM_TOKEN=""
ALERT=""

_run
clear
printf "%s\n" "${ALERT}"
menu_telegram
